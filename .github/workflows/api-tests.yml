name: API 自动化测试

on:
  # 暂时禁用自动触发，只支持手动触发
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]
  # schedule:
  #   - cron: '0 1 * * *'
  workflow_dispatch:  # 只支持手动触发

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
      fail-fast: false  # 一个版本失败不影响其他版本
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 配置测试环境
      env:
        KMSK_ADMIN_USERNAME: ${{ secrets.KMSK_ADMIN_USERNAME }}
        KMSK_ADMIN_PASSWORD: ${{ secrets.KMSK_ADMIN_PASSWORD }}
        KMSK_STUDENT_USERNAME: ${{ secrets.KMSK_STUDENT_USERNAME }}
        KMSK_STUDENT_PASSWORD: ${{ secrets.KMSK_STUDENT_PASSWORD }}
        TAPD_ENABLED: ${{ secrets.TAPD_ENABLED }}
        TAPD_WORKSPACE_ID: ${{ secrets.TAPD_WORKSPACE_ID }}
        TAPD_API_USER: ${{ secrets.TAPD_API_USER }}
        TAPD_API_PASSWORD: ${{ secrets.TAPD_API_PASSWORD }}
        TAPD_TEST_PLAN_ID: ${{ secrets.TAPD_TEST_PLAN_ID }}
        WECOM_ENABLED: ${{ secrets.WECOM_ENABLED }}
        WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
        API_RATE_LIMIT_SECONDS: 1  # CI 环境缩短延时
      run: |
        echo "环境变量已配置"
    
    - name: 运行测试（管理后台）
      run: |
        python scripts/run_api_tests.py api_tests/admin -v --junit
      continue-on-error: true
    
    - name: 运行测试（EduPC端）
      run: |
        python scripts/run_api_tests.py api_tests/edupc -v --junit
      continue-on-error: true
    
    - name: 运行测试（H5端）
      run: |
        python scripts/run_api_tests.py api_tests/h5 -v --junit
      continue-on-error: true
    
    - name: 上传测试报告
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-py${{ matrix.python-version }}
        path: reports/
        retention-days: 30
    
    - name: 发布测试结果
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: reports/junit.xml
        check_name: 测试结果 (Python ${{ matrix.python-version }})
    
    - name: 评论 PR（失败时）
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '⚠️ API 自动化测试失败，请检查测试报告。'
          })

  # 冒烟测试任务（快速验证）
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 运行冒烟测试
      env:
        KMSK_ADMIN_USERNAME: ${{ secrets.KMSK_ADMIN_USERNAME }}
        KMSK_ADMIN_PASSWORD: ${{ secrets.KMSK_ADMIN_PASSWORD }}
        API_RATE_LIMIT_SECONDS: 0  # 冒烟测试不延时
      run: |
        # 只运行标记为 smoke 的用例（如果有的话）
        python scripts/run_api_tests.py api_tests/admin/test_admin_add_audio.py -v --junit
    
    - name: 上传冒烟测试报告
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-report
        path: reports/
        retention-days: 7
