# 开发规范

## 1. 用例编写标准

### 1.1 命名
- 文件名：`test_<端>_<业务>.py`（如 `test_admin_add_audio.py`）
- 函数名：`test_<端>_<业务>_<动作>`
- 文件头注释：
  ```python
  """
  用例 ID: 1150695810001062392
  用例名称: 管理后台正常添加音频课程
  接口: POST /ajax/wxAppAudio_h.jsp?cmd=add
  """
  ```

### 1.2 结构（固定三段）
- **Arrange**：准备数据（来自 `TestDataManager` / `DataFactory` / `payloads`）
- **Act**：调用 action/client
- **Assert**：断言核心成功条件

### 1.3 断言标准
1. 接口成功断言：`client.assert_success(result, "xxx失败")`
2. 关键字段断言：`assert_field` / `assert_any_field`
3. 错误信息包含业务语义

### 1.4 数据清理
- 创建类用例使用 `try/finally` + `DeleteActions`
- ID 变量在 `try` 前初始化为 `None`
- `finally` 中判断 `if resource_id:` 再清理
- 特殊情况（测评/兑换码/答题活动/学员）不清理，在文件头注释说明

### 1.5 新增用例模板
```python
"""
用例 ID: 1150695810001XXXXXXXX
用例名称: 管理后台正常添加XXX
接口: POST /xxx
"""
from payloads.admin_payloads import build_add_xxx_payload
from actions.delete_actions import DeleteActions
from utils.response_assert import assert_any_field


def test_admin_add_xxx(admin_client, timestamp):
    name = f"接口测试XXX_{timestamp}"
    resource_id = None

    try:
        result = admin_client.post("/xxx", data=build_add_xxx_payload(name))
        admin_client.assert_success(result, "创建XXX失败")
        resource_id = assert_any_field(result, ["data.id", "id"], msg="XXX ID为空")
    finally:
        if resource_id:
            DeleteActions.delete_xxx(admin_client, resource_id)
```

---

## 2. 断言工具规范

工具文件：`api_tests/utils/response_assert.py`

| 函数 | 用途 |
|------|------|
| `get_field(resp, "data.orderNo", default=None)` | 安全读取嵌套字段 |
| `assert_field(resp, "data.orderNo", str, msg="...")` | 断言字段存在 + 可选类型校验 |
| `assert_any_field(resp, ["data.id", "id"], msg="...")` | 多候选路径至少一条可用 |

### 规则
- 禁止 `resp.get("data", {}).get("x")` 链式写法
- 优先使用 `assert_field` / `get_field` / `assert_any_field`
- `msg` 包含业务语义

---

## 3. 契约层（JSON Schema）

### 3.1 机制
- `BaseClient.post/get` 接受可选 `schema` 参数
- `_parse_response()` 在 `success=true` 时执行 JSON Schema 校验
- 失败抛 `ContractValidationError`（含字段路径 + 期望/实际）

### 3.2 Schema 目录
```
api_tests/schemas/
├── registry.py              # schema 名 → 文件路径映射
├── admin/                   # Admin 创建类 schema
├── order/                   # 订单 schema
├── answer/                  # 答题 schema
└── designer/                # 设计器 schema
```

### 3.3 已覆盖范围
- 订单：`order.commit`、`order.detail`
- 答题：`answer.add_record`、`answer.detail`
- Admin 创建类：17 个全覆盖
- Designer：mobile 新增页面、edupc 新增栏目/模块
- 跨端验收：创建/删除音频

### 3.4 新增 schema 流程
1. 在 `schemas/<模块>/` 新建 `.schema.json`
2. 在 `schemas/registry.py` 注册映射
3. 在调用处加 `schema="xxx.yyy"`

---

## 4. Payload 模板规范

### 4.1 目录
- 模板统一放 `api_tests/payloads/`
- 函数命名：`build_xxx_payload(...)`
- 只暴露可变参数（名称、wxapp_id、file_id 等）

### 4.2 规则
- 用例文件只保留"业务变量 + 调用 + 断言/清理"
- 调用方式：`data=build_xxx_payload(...)`
- 禁止在用例内堆超长内联 JSON
- 出现第二处复用即下沉到模板

### 4.3 已有模板（`payloads/admin_payloads.py`）
`build_add_form_payload`、`build_add_offline_course_payload`、`build_add_evaluation_payload`、`build_add_redemption_code_payload`、`build_add_book_service_payload`、`build_add_coupon_payload`、`build_add_product_payload`、`build_add_question_bank_payload`、`build_add_ebook_payload`、`build_add_answer_activity_payload`、`build_add_audio_payload`、`build_default_task_list`

---

## 5. DeleteActions 支持的资源类型

| 资源 | 方法 |
|------|------|
| 线下课程 | `delete_offline_course(client, id)` |
| 系列课 | `delete_column(client, id)` |
| 图文 | `delete_news(client, id)` |
| 音频 | `delete_audio(client, id)` |
| 视频 | `delete_video(client, id)` |
| 电子书 | `delete_ebook(client, id)` |
| 课外服务 | `delete_book_service(client, id)` |
| 实物商品 | `delete_product(client, id)` |
| 题库 | `delete_question_bank(client, id)` |
| 作业 | `delete_homework(client, id)` |
| 打卡 | `delete_checkpoint(client, id)` |
| 表单 | `delete_form(client, id)` |
| 优惠券 | `delete_coupon(client, id)` |

扩展时在 `DeleteActions` 添加静态方法，参考现有命名风格。
