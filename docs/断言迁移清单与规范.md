# 断言迁移清单与规范

## 目标

统一接口测试中的响应访问与断言风格，减少重复代码，提升可读性、可维护性与错误定位效率。

当前统一方案：
- `client.assert_success(resp, msg)`：断言接口成功（保留现有方案）
- `utils.response_assert`：统一字段访问与字段断言

---

## 工具约定

工具文件：`api_tests/utils/response_assert.py`

提供能力：
- `get_field(resp, "data.orderNo", default=None)`  
  安全读取字段，不存在时返回默认值
- `assert_field(resp, "data.orderNo", str, msg="订单号为空")`  
  断言字段存在，且可选校验类型，返回字段值
- `assert_any_field(resp, ["data.id", "id"], msg="未返回ID")`  
  断言候选路径至少一条可用，适配多返回结构

---

## 使用规则（团队统一）

1. **成功断言优先**
- 先执行 `client.assert_success(...)`
- 再做字段级断言

2. **字段访问统一**
- 禁止新增 `resp.get("data", {}).get("x")` 链式写法
- 优先使用 `assert_field/get_field/assert_any_field`

3. **类型校验明确**
- ID、订单号、列表等关键字段建议带类型校验（`str/int/list/dict`）
- 对可选结构使用 `assert_any_field`

4. **错误信息语义化**
- `msg` 要包含业务语义：如“订单号为空”“答题记录缺少 data”
- 不使用笼统错误文案

5. **迁移粒度**
- 小批迁移（2-5个文件）+ 小批回归（对应用例）
- 不做全量一次性替换

---

## 本次迁移清单（已完成）

### 工具层
- `api_tests/utils/response_assert.py`（新增）
- `api_tests/utils/__init__.py`（导出新增工具）

### Actions 层
- `api_tests/actions/order_actions.py`
- `api_tests/actions/answer_actions.py`
- `api_tests/actions/mobile_designer_actions.py`
- `api_tests/actions/edupc_designer_actions.py`

### 用例层
- H5：
  - `api_tests/h5/test_h5_order_book_service.py`
  - `api_tests/h5/test_h5_order_offline_course.py`
  - `api_tests/h5/test_h5_order_product.py`
- Cross Platform：
  - `api_tests/cross_platform/test_admin_create_c_side_view.py`
- Mobile Designer：
  - `api_tests/mobile_designer/test_mobile_designer_common.py`
  - `api_tests/mobile_designer/test_mobile_designer_course.py`
  - `api_tests/mobile_designer/test_mobile_designer_study.py`
  - `api_tests/mobile_designer/test_mobile_designer_marketing.py`
- Admin 创建类：
  - `api_tests/admin/test_admin_add_answer_activity.py`
  - `api_tests/admin/test_admin_add_student.py`
  - `api_tests/admin/test_admin_add_coupon.py`
  - `api_tests/admin/test_admin_add_book_service.py`
  - `api_tests/admin/test_admin_add_checkpoint.py`
  - `api_tests/admin/test_admin_add_homework.py`
  - `api_tests/admin/test_admin_add_question_bank.py`
  - `api_tests/admin/test_admin_add_product.py`
  - `api_tests/admin/test_admin_add_ebook.py`
  - `api_tests/admin/test_admin_add_form.py`
  - `api_tests/admin/test_admin_add_offline_course.py`
  - `api_tests/admin/test_admin_add_audio.py`
  - `api_tests/admin/test_admin_add_video.py`
  - `api_tests/admin/test_admin_add_news.py`
  - `api_tests/admin/test_admin_add_column.py`

---

## 回归验证摘要

已按“分批迁移 + 分批回归 + 组合回归”执行：
- 关键链路用例（order/answer/cross）通过
- mobile_designer 全量通过
- edupc_designer 全量通过
- admin 创建类批量通过
- 组合回归（admin + designer）通过

---

## 后续新增用例模板（推荐）

```python
from utils.response_assert import assert_field, assert_any_field, get_field

result = client.post(...)
client.assert_success(result, "创建资源失败")

resource_id = assert_any_field(result, ["data.id", "id"], msg="未返回资源ID")
detail = assert_field(result, "data", dict, msg="响应缺少data")
items = get_field(detail, "list", default=[])
```

---

## 不纳入本次强制迁移的范围

- `clients/*`：登录、会话、协议层处理（保持灵活）
- `conftest.py`、`config_loader.py`、通知器等基础设施文件

这些文件不属于测试业务断言重复问题，不建议强制统一为业务断言风格。

