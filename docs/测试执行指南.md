# 测试执行指南

## 🚀 快速开始

### 推荐执行方式（并发）
```bash
# 使用并发脚本（推荐）
powershell -ExecutionPolicy Bypass -File run_tests_concurrent.ps1

# 总耗时: ~87秒
# 通过率: 100%
# 性能提升: 21.6%
```

### 串行执行（备用）
```bash
# 全部用例串行执行
pytest api_tests/ -q

# 总耗时: ~111秒
# 通过率: 100%
```

---

## ⚙️ 限频机制说明

### 触发条件
系统会在以下情况自动添加2秒延时：

| 触发条件 | 说明 | 覆盖用例 |
|---------|------|----------|
| `@pytest.mark.write` | 写操作接口 | EduPC订单（5个） |
| `@pytest.mark.rate_limited` | 显式标记需要限频 | 设计器用例（7个） |
| H5 路径 | `/api_tests/h5/` 下所有用例 | H5订单（11个） |

### 环境变量控制
```bash
# .env 文件
API_RATE_LIMIT_SECONDS=2        # 延时秒数（默认2秒）
API_RATE_LIMIT_ALL=0            # 全局限频（0=否，1=是）
```

### 限频问题解决方案

#### 问题1: EduPC音频订单偶发失败
**原因**: 缺少限频保护标记  
**解决**: 已添加 `@pytest.mark.write` 标记  
**状态**: ✅ 已解决

#### 问题2: H5用例并发冲突
**原因**: H5 session 跨进程共享冲突  
**解决**: 采用分离执行策略（H5串行，其他并发）  
**状态**: ✅ 已解决

---

## 📋 并发执行原理

### 分离执行策略
```bash
# 步骤1: 并发执行非H5用例（29个）
pytest api_tests/ -n 2 --dist loadscope --ignore=api_tests/h5/ -q
# 耗时: ~34秒

# 步骤2: 串行执行H5用例（11个）
pytest api_tests/h5/ -q
# 耗时: ~49秒

# 总耗时: ~87秒（vs 串行111秒）
```

### 为什么H5用例要串行？
- H5客户端使用 `scope="session"` 的fixture
- 并发执行时，多个进程共享同一个session会冲突
- 串行执行避免session冲突，保证100%通过率

---

## 🔧 常见问题

### Q1: 如何只运行某个模块的测试？
```bash
# 只运行管理后台测试
pytest api_tests/admin/ -v

# 只运行EduPC测试
pytest api_tests/edupc/ -v

# 只运行设计器测试
pytest api_tests/edupc_designer/ api_tests/mobile_designer/ -v
```

### Q2: 如何查看详细日志？
```bash
# 显示详细输出
pytest api_tests/ -v -s

# 生成HTML报告
pytest api_tests/ --html=report.html --self-contained-html
```

### Q3: 如何查看最慢的用例？
```bash
# 显示最慢的10个用例
pytest api_tests/ --durations=10
```

### Q4: 遇到限频错误怎么办？
```bash
# 方案1: 增加延时
export API_RATE_LIMIT_SECONDS=3

# 方案2: 启用全局限频
export API_RATE_LIMIT_ALL=1

# 方案3: 串行执行
pytest api_tests/ -q
```

---

## 📊 性能对比

| 执行方式 | 耗时 | 通过率 | 说明 |
|---------|------|--------|------|
| **并发执行（推荐）** | 87秒 | 100% | 使用 `run_tests_concurrent.ps1` |
| 串行执行 | 111秒 | 100% | 稳定但较慢 |
| 全量并发(n=2) | 56秒 | 87.5% | H5冲突，不推荐 |

---

## ✅ 验收标准

- [x] 全部40个用例通过（100%）
- [x] 总耗时 < 90秒
- [x] 无限频错误
- [x] 无session冲突

---

**最后更新**: 2026-02-12  
**版本**: v1.0  
**状态**: ✅ 生产就绪
