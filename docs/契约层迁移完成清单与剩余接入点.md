# 契约层迁移完成清单与剩余接入点

## 1. 本次已完成范围

### 1.1 基础能力
- 在 `api_tests/clients/base_client.py` 增加可选 `schema` 参数，并在 `_parse_response()` 中执行契约校验。
- 新增结构化请求/响应日志与失败上下文 dump。
- 新增 `trace_id / request_id / client_request_id` 关联能力。
- 新增响应契约校验工具：`api_tests/utils/contract_validator.py`。
- 新增 schema 注册中心：`api_tests/schemas/registry.py`。

### 1.2 订单与答题链路
- `order.commit`、`order.detail` 已接入（EduPC/H5 下单与后台查单）。
- `answer.add_record`、`answer.detail` 已接入。
- 答题链路关键预热/保存/提交/批阅接口补充 `common.success` 契约校验。

### 1.3 Admin 创建类用例
- 已覆盖：
  - 音频、视频、图文、系列课
  - 电子书、实物商品、超级题库
  - 作业、打卡、优惠券、答题活动
  - 线下课、表单、学员、课外服务
  - 测评、兑换码

### 1.4 Designer 关键动作
- 已覆盖：
  - Mobile 设计器新增页面
  - EduPC 设计器新增栏目
  - EduPC 设计器新增模块

### 1.5 跨端验收
- `api_tests/cross_platform/test_admin_create_c_side_view.py` 的创建/删除动作已接入契约层。


## 2. 新增/复用的 schema 说明

### 2.1 通用 schema
- `admin/common_success_response.schema.json`
- `admin/common_create_id_response.schema.json`

### 2.2 专用 schema（示例）
- 订单：`order/commit_order_response.schema.json`、`order/order_detail_response.schema.json`
- 答题：`answer/add_record_response.schema.json`、`answer/answer_detail_response.schema.json`
- Designer：`designer/designer_add_col_response.schema.json`、`designer/designer_add_module_response.schema.json`
- 其他专用：`admin/student_create_response.schema.json`、`admin/book_service_create_response.schema.json`


## 3. 迁移后回归结果（分批执行）

- EduPC 订单 + 答题批次：通过
- H5 订单批次：通过
- Admin 创建类批次（多轮）：通过
- Designer 批次：通过
- 跨端验收批次：通过

说明：个别跨端查询接口在某些环境返回 404，但用例本身已按原有容错逻辑处理，不影响本次契约层改造验证。


## 4. 已做的冗余优化与可清理项

- 抽取作业/打卡重复 payload：`api_tests/admin/_checkpoint_payloads.py`。
- 删除并忽略 session 缓存文件：`api_tests/.edupc_designer_session_cache.pkl`。
- `.gitignore` 已补充 designer 相关 `.pkl` 缓存规则，避免后续误提交。


## 5. 剩余接入点（建议但非必须）

以下接口变化频率较高或对业务价值较低，建议按需接入：
- `actions/delete_actions.py` 中各类删除接口（当前以成功断言为主）。
- `actions/refund_actions.py`（可接入 `common.success`，收益中等）。
- `actions/edupc_designer_actions.py` 中部分查询类/资源列表类接口（当前已覆盖新增核心动作）。

建议策略：
- 新增写接口默认接入 schema。
- 查询接口按“高价值 + 高变更风险”优先补齐。
- 统一优先复用通用 schema，必要时再建专用 schema。


## 6. Payload 模板规范（P0-2）

### 6.1 目录与命名
- 模板统一放在 `api_tests/payloads/`，按业务聚合（当前为 `admin_payloads.py`）。
- 函数命名统一：`build_xxx_payload(...)`。
- 模板函数只暴露可变参数（如名称、`wxapp_id`、`file_id`），其余稳定字段内聚在模板内。

### 6.2 使用规则
- 用例文件只保留“业务变量 + 调用行为 + 断言/清理”，不再内联大段 JSON。
- 用例中调用方式统一为：`data=build_xxx_payload(...)`。
- 允许在用例内保留少量动态参数拼装（如 `timestamp`、环境特定 ID），但不展开复杂结构体。

### 6.3 禁止项
- 禁止在测试用例中直接堆叠超长内联 JSON（尤其是 `setting`、`questionList`、`entries` 这类字段）。
- 禁止在多个用例重复复制同一 payload 结构；出现第二处复用即应下沉到模板。

### 6.4 新增用例接入建议
- 新写“创建类/写操作”用例时，先在 `api_tests/payloads/` 新增或复用模板函数，再编写用例逻辑。
- 若模板字段发生业务变化，优先修改模板函数，不在多个测试文件分别修补。
