# 自动化验收新流程说明（API 优先）

## 背景

原流程以 UI 执行为主，存在三个典型问题：
- UI 识别与快照调用成本高
- 选择器脆弱导致执行不稳定
- 重跑依赖会话上下文，复用性差

新流程改为：**API 主干回归 + 小规模 UI 冒烟 + 统一结果聚合**。

## 流程总览

1. 读取 `config/acceptance_pipeline.json`
2. 执行 API 核心回归（`api_tests/`）
3. 执行 UI 冒烟（`config/ui_smoke_plan.json`）
4. 汇总到 `test_plan_execution_results.json`
5. 生成 `reports/acceptance/latest.md` 供人工复核后回填 TAPD

## 执行命令

```bash
npm run acceptance:pipeline
```

可拆分执行：

```bash
npm run acceptance:api-core
npm run acceptance:ui-smoke
```

Windows 说明：
- 默认脚本使用 `py -3` 执行 pytest
- 若 `py` 不可用，可改用 `python -m pytest api_tests -v -s`

## UI 冒烟策略

- 固定 5 条高风险链路（稳定、可复用）
- 每周轮换 2 条补充覆盖（防盲区）
- 轮换逻辑：`iso-week-modulo`

配置见：`config/ui_smoke_plan.json`

## API 迁移策略

映射维护在：`config/case_api_mapping.json`

- `status=ready`：已落地 API 测试
- `status=planned`：待迁移

建议每次版本至少新增 2-3 条 `planned -> ready`。

## API 捕获与转换（Windows）

新增一键捕获脚本（从 JSON UI 步骤抓取关键接口）：

```bash
npm run acceptance:capture-case -- --caseId=1150695810001062391
```

批量按分组捕获（示例：admin 组）：

```bash
npm run acceptance:capture-group -- --group=admin
```

捕获结果保存到：`api_captures/{caseId}.json`

API 回归会自动读取 `api_captures` 中的 `keyApi` 并回放，
只要在 `case_api_mapping.json` 中将该用例标记为 `ready` 即可进入主干回归。

同步映射（自动把"已捕获"的 case 标记为 ready）：

```bash
npm run acceptance:sync-mapping
```

## 输出与回填建议

- 本地先看 `reports/acceptance/latest.md`
- 确认后再统一回填 TAPD，避免中途反复修改状态
